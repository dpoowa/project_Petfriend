<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 게시글 목록 가져오기 -->
<mapper namespace="com.tech.petfriends.community.mapper.IDao">
	
	<select id="getPostList"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT CD.*, RCI.*, MP.PET_IMG 
		FROM COMMUNITY_BOARD CD
		INNER JOIN RE_CBOARD_IMAGE RCI ON CD.BOARD_NO = RCI.BOARD_NO
		INNER JOIN MEMBER_PET MP ON CD.MEM_CODE = MP.MEM_CODE
		WHERE MP.PET_MAIN = 'Y'
		ORDER BY CD.BOARD_NO DESC
	</select>

	
	<select id="getPetIMG"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT PET_IMG FROM MEMBER_PET
		WHERE MEM_CODE = #{mem_code} 
		AND PET_MAIN = 'Y' 		
	</select> 
	

	<insert id="write">
		INSERT INTO COMMUNITY_BOARD (BOARD_NO,
		B_CATE_NO, MEM_CODE, USER_ID,
		BOARD_TITLE, BOARD_PASSWORD, BOARD_CONTENT, BOARD_CREATED, BOARD_MODIFIED,
		BOARD_VIEWS,BOARD_TAG, BOARD_LIKES, BOARD_COMMENT_COUNT)
		VALUES
		(COMMUNITY_BOARD_SEQ.NEXTVAL, #{b_cate_no},#{mem_code}, #{mem_nick}, #{board_title},
		1234, #{board_content},SYSDATE, null, 3, 'tag1', 1, 0)
	</insert>

	<select id="selBid" resultType="_int">
		SELECT MAX(BOARD_NO) FROM
		COMMUNITY_BOARD
	</select>

	<insert id="imgWrite">
		INSERT INTO RE_CBOARD_IMAGE(REBNO, BOARD_NO,
		CORGFILE, CCHGFILE, OREPFILE, CHREPFILE) VALUES
		(RE_CBOARD_IMAGE_SEQ.NEXTVAL,
		#{board_no}, #{originalFile},
		#{changeFile}, #{repImgOriginal}, #{repImgChange})
	</insert>

	<select id="contentView"
		resultType="com.tech.petfriends.community.dto.CDto">		
		SELECT CD.*, RCI.*, MP.PET_IMG 
		FROM COMMUNITY_BOARD CD
		INNER JOIN RE_CBOARD_IMAGE RCI ON CD.BOARD_NO = RCI.BOARD_NO
		INNER JOIN MEMBER_PET MP ON CD.MEM_CODE = MP.MEM_CODE
		WHERE CD.BOARD_NO = #{board_no} AND MP.PET_MAIN = 'Y'
	</select>


	<select id="selectImg"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM RE_CBOARD_IMAGE WHERE BOARD_NO = #{board_no}
	</select>

	<select id="getCategoryList"
		resultType="com.tech.petfriends.community.dto.CCategoryDto">
		SELECT B_CATE_NO, B_CATE_NAME FROM BOARD_CATEGORY
	</select>

	<select id="getPostsByCategory" parameterType="int"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM COMMUNITY_BOARD
		<if test="b_cate_no != 0">
			WHERE B_CATE_NO = #{b_cate_no} ORDER BY BOARD_NO DESC
		</if>
	</select>

	<select id="getAllPosts"
		resultType="com.tech.petfriends.community.dto.CDto">
		SELECT * FROM COMMUNITY_BOARD
	</select>


	<update id="modify">
		UPDATE COMMUNITY_BOARD
		SET BOARD_TITLE = #{param2},
		BOARD_CONTENT = #{param3},
		BOARD_MODIFIED = CURRENT_TIMESTAMP,
		B_CATE_NO = #{param4}
		WHERE BOARD_NO = #{param1}
	</update>

	<update id="modifyImg">
		UPDATE RE_CBOARD_IMAGE
		SET CORGFILE = #{originalFile},
		CCHGFILE = #{changeFile},
		OREPFILE = #{repImgOriginal},
		CHREPFILE = #{repImgChange}
		WHERE BOARD_NO = #{board_no}
	</update>

	<delete id="delete">
		DELETE FROM COMMUNITY_BOARD WHERE BOARD_NO = #{board_no}
	</delete>

	<insert id="comment">
		INSERT INTO COMMUNITY_COMMENT (COMMENT_NO, BOARD_NO, USER_ID,
		COMMENT_CONTENT, CREATED_DATE, PARENT_COMMENT_NO, COMMENT_LEVEL,
		COMMENT_ORDER_NO, EDITED_DATE)
		VALUES (COMMUNITY_COMMENT_SEQ.NEXTVAL, #{board_no}, #{mem_nick},
		#{comment_content}, SYSDATE, COMMUNITY_COMMENT_SEQ.CURRVAL,0,0, SYSDATE)
	</insert>

	<select id="commentList"
		resultType="com.tech.petfriends.community.dto.CCommentDto">
		SELECT DISTINCT CC.*, MP.PET_IMG
		FROM COMMUNITY_COMMENT CC
		JOIN COMMUNITY_BOARD CB ON CC.BOARD_NO = CB.BOARD_NO
		JOIN MEMBER_PET MP ON CB.MEM_CODE = MP.MEM_CODE
		WHERE CC.COMMENT_LEVEL = 0 
		AND CC.BOARD_NO = #{board_no}
		AND MP.PET_IMG IS NOT NULL
		ORDER BY CC.COMMENT_NO
	</select>

	<insert id="commentReply">
		INSERT INTO COMMUNITY_COMMENT (COMMENT_NO, BOARD_NO, USER_ID,
		COMMENT_CONTENT, CREATED_DATE, PARENT_COMMENT_NO, COMMENT_LEVEL,
		COMMENT_ORDER_NO, EDITED_DATE)
		VALUES (COMMUNITY_COMMENT_SEQ.NEXTVAL, #{board_no}, #{mem_nick},
		#{comment_content}, SYSDATE, #{parent_comment_no}, #{comment_level} + 1,
		#{comment_order_no} + 1, SYSDATE)
	</insert>

	<select id="commentReplyList"
		resultType="com.tech.petfriends.community.dto.CCommentDto">
		SELECT CC.*, MP.PET_IMG
		FROM COMMUNITY_COMMENT CC
		JOIN COMMUNITY_BOARD CB ON CC.BOARD_NO = CB.BOARD_NO
		JOIN MEMBER_PET MP ON CB.MEM_CODE = MP.MEM_CODE
		WHERE CC.COMMENT_LEVEL >= 1 
		AND CC.BOARD_NO = #{board_no}
		AND MP.PET_IMG IS NOT NULL		
		ORDER BY CC.COMMENT_LEVEL
	</select>

	<update id="commentShape">
		UPDATE COMMUNITY_COMMENT
		SET
		comment_level=comment_level + 1
		WHERE PARENT_COMMENT_NO=#{param1} AND
		COMMENT_LEVEL > #{param2}
	</update>


	<delete id="replyDelete">
		DELETE FROM COMMUNITY_COMMENT
		WHERE (SELECT
		COUNT(COMMENT_NO) FROM COMMUNITY_COMMENT
		WHERE PARENT_COMMENT_NO=#{parent_comment_no}
		AND COMMENT_LEVEL = #{comment_level}+1
		AND COMMENT_ORDER_NO > #{comment_order_no})=0
		AND COMMENT_NO=#{comment_no}
	</delete>


	<update id="stepInit">
		UPDATE COMMUNITY_COMMENT SET
		COMMENT_LEVEL=COMMENT_LEVEL-1
		WHERE PARENT_COMMENT_NO = #{parent_comment_no}
		AND COMMENT_LEVEL> #{comment_level}
	</update>

	<insert id="addLike">
		INSERT INTO COMMUNITY_LIKES 
		(LIKE_ID, BOARD_NO, USER_ID, CREATED_DATE) 
		VALUES (COMMUNITY_LIKES_SEQ.NEXTVAL, #{board_no}, #{user_id}, SYSDATE)
	</insert>

	<delete id="removeLike">
		DELETE FROM COMMUNITY_LIKES 
		WHERE board_no = #{board_no} AND user_id = #{user_id}
	</delete>

	<select id="isLiked" resultType="int">
		SELECT COUNT(*) FROM COMMUNITY_LIKES 
		WHERE board_no = #{board_no} AND user_id =
		#{user_id}
	</select>

</mapper>